#!/usr/bin/env bash

set -e
set -u
set -o pipefail

declare -r git_repo="https://github.com/ezraai/job2docker.git"
declare -r work_dir="j2d"

declare -r shared_job_dir="${1:-${HOME}/shared_jobs}"
declare -r root_dir="${2:-${HOME}/talend}"

echo "Starting Talend job2docker install to ${root_dir}"

mkdir -p "${root_dir}"
cd "${root_dir}"

# clone the job2docker repo
git clone "${git_repo}"

# create j2d working directory
mkdir -p "${root_dir}/${work_dir}"
cd "${root_dir}/${work_dir}"

# unzip job2docker_listener
unzip "${root_dir}/job2docker/jobs/job2docker_listener_0.1.zip"

# create containerized directory
mkdir -p "${root_dir}/${work_dir}/containerized"

# set exec permission on job2docker_listener
chmod +x "${root_dir}/${work_dir}/job2docker_listener/job2docker_listener_run.sh"

# create job2docker_listener context variables default properties file
# note that the working_dir in the properties file below is different than the work_dir used in this script

pwd

cat > "${root_dir}/${work_dir}/job2docker_listener/se_demo/job2docker_listener_0_1/contexts/Default.properties" <<EOF
# generated by job2docker-setup
job_zip_source_dir=${shared_job_dir}
job_zip_target_dir=${root_dir}/${work_dir}/containerized
working_dir=
package_command=${root_dir}/job2docker/bin/job2docker
build_command=${root_dir}/job2docker/job2docker_build/build
deploy_command=${root_dir}/job2docker/bin/deploy-aws
job_owner=${USER}
shell_log_file=${root_dir}/${work_dir}/job2docker.log
EOF

cat > "${root_dir}/job2docker_listener" <<EOF
cd "${root_dir}/${work_dir}/job2docker_listener"
./job2docker_listener_run.sh
EOF
chmod u+x "${root_dir}/job2docker_listener"

echo "Finished installing Talend job2docker to '${root_dir}'"
echo "job2docker will listen on '${shared_job_dir}'"
echo "To run job2docker:    ${root_dir}/job2docker_listener"
echo "Use Taled Studio to build a job zip file to this shared directory"
